<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MISE - Public Gallery Edition</title>
    <style>
        :root {
            --bg: #0a0a0a; --card: #141414; --accent: #f97316; 
            --border: #222; --text: #f4f4f5; --text-dim: #71717a;
            --input-bg: #000; --danger: #ef4444; --success: #22c55e;
            --exp-accent: #0b5394;
        }

        body { font-family: -apple-system, Inter, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        /* Default to viewer mode - Admin elements hidden */
        body.is-viewer .admin-only { display: none !important; }
        
        .access-bar { background: #000; padding: 6px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); margin: -10px -10px 10px -10px; font-size: 0.7rem; }
        .brand-title { color: var(--accent); margin: 5px 0; font-size: 1.5rem; letter-spacing: 2px; font-weight: 900; }
        
        #searchBox { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 12px; outline: none; }
        
        .scroll-box { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--card); max-height: 80vh; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.75rem; min-width: 1600px; }
        
        thead { position: sticky; top: 0; z-index: 3; }
        th { padding: 12px 8px; background: #0f0f0f; color: var(--text-dim); text-transform: uppercase; font-size: 0.6rem; cursor: pointer; border-bottom: 1px solid var(--border); white-space: normal; line-height: 1.2; vertical-align: bottom; position: sticky; top: 0; }
        th.active-sort { color: var(--accent); border-bottom: 2px solid var(--accent); background: rgba(249, 115, 22, 0.05); }
        td { padding: 8px; border-bottom: 1px solid var(--border); text-align: center; vertical-align: middle; }
        
        .sticky-col { text-align: left; position: sticky; left: 0; background: var(--card); z-index: 2; width: 340px; border-right: 1px solid var(--border); }
        thead th.sticky-col { z-index: 4; }
        
        .poster { width: 30px; height: 45px; border-radius: 2px; object-fit: cover; background: #222; margin-right: 10px; flex-shrink: 0; cursor: pointer; transition: transform 0.2s; }
        .poster:hover { transform: scale(1.1); }
        .movie-name { font-weight: 700; color: var(--accent); cursor: pointer; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .meta-row { font-size: 0.65rem; color: var(--text-dim); margin-top: 1px; line-height: 1.2; }
        .cast-row { font-size: 0.6rem; color: #555; font-style: italic; margin: 2px 0; }
        
        .ott-link { display: inline-block; padding: 3px 8px; background: var(--success); color: #000; border-radius: 4px; font-weight: 900; font-size: 0.55rem; text-decoration: none; margin-top: 4px; }
        .edit-btn { background: transparent; border: 1px solid var(--border); color: var(--text-dim); font-size: 0.55rem; padding: 1px 5px; border-radius: 3px; cursor: pointer; margin-left: 5px; }
        
        .tag-pill { display: inline-block; padding: 2px 6px; border-radius: 4px; background: rgba(249, 115, 22, 0.05); color: var(--text-dim); font-size: 0.55rem; margin: 2px 2px 0 0; border: 1px solid #333; }
        .list-tag { border-color: var(--accent); color: var(--accent); cursor: pointer; transition: opacity 0.2s; }
        .list-tag:hover { opacity: 0.7; }
        .tag-pill.active { background: rgba(249, 115, 22, 0.2); border-color: var(--accent); color: var(--accent); }

        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:100; justify-content:center; align-items:center; padding:15px; backdrop-filter: blur(10px); }
        .modal-content { background:var(--card); padding:20px; border-radius:12px; width:100%; max-width:400px; border:1px solid var(--border); max-height: 90vh; overflow-y: auto; position: relative; }
        
        .slider-row { margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid #1a1a1a; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 3px; background: #333; outline: none; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #fff; border: 2px solid var(--accent); cursor: pointer; }
        
        .btn { background: var(--accent); color: #fff; border: none; padding: 10px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 8px; font-size: 0.8rem; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
        .btn-danger { background: var(--danger); color: #fff; }

        input.mini-input, textarea.mini-input { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); padding: 8px; margin-bottom: 8px; width: 100%; box-sizing: border-box; border-radius: 4px; outline: none; font-size: 0.8rem; }
        textarea.mini-input { min-height: 120px; resize: vertical; font-family: inherit; }

        .score-keyword { display: block; font-size: 0.55rem; color: #a1a1aa; opacity: 0.8; margin-top: 2px; }
        .desc-popup { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 10px 15px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; z-index: 200; pointer-events: none; opacity: 0; transition: opacity 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; max-width: 80%; }

        /* Detail Modal Specifics */
        .detail-header { display: flex; gap: 15px; margin-bottom: 20px; }
        .detail-poster { width: 100px; height: 150px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); }
        .score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .score-item { background: #1a1a1a; padding: 8px; border-radius: 6px; border-left: 3px solid var(--accent); }
        .score-item.exp { border-left-color: var(--exp-accent); }
        .score-label { font-size: 0.6rem; color: var(--text-dim); display: block; }

        /* Navigation Arrows (Additive) */
        .nav-arrow { position: fixed; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: 1px solid var(--border); padding: 15px 10px; border-radius: 8px; cursor: pointer; z-index: 101; font-weight: bold; }
        .nav-prev { left: 10px; }
        .nav-next { right: 10px; }

       @media (max-width: 600px) {
            th { min-width: 60px; padding: 8px 4px; font-size: 0.55rem; }
            .nav-arrow { padding: 12px 8px; z-index: 102; background: rgba(0,0,0,0.8); }
            
            /* Reduced Height & Removed Border for Mobile */
            .modal { padding: 10px; align-items: center; }
            .modal-content { 
                width: 88%; 
                max-width: 380px;
                max-height: 70vh; /* Further reduced height */
                padding: 12px; 
                overflow-y: auto; 
                margin: auto;
                border: 1px solid var(--border); /* Removed orange, back to standard dim border */
                border-radius: 8px;
            }

            /* Compact Detail Layout */
            .detail-header { 
                flex-direction: column; 
                align-items: center; 
                text-align: center; 
                gap: 8px; 
                margin-bottom: 10px;
            }
            .detail-poster { width: 80px; height: 120px; } /* Slightly smaller poster to save vertical space */
            
            .score-grid { 
                grid-template-columns: 1fr; 
                gap: 8px; 
            }

            .sticky-col { width: 180px; min-width: 180px; }
            .scroll-box { margin: 0 -10px; width: calc(100% + 20px); border-radius: 0; }
        }
    </style>
</head>
<body class="is-viewer">

    <div id="descPopup" class="desc-popup"></div>

    <div class="access-bar">
        <span>MISE_V33: <b style="color:var(--accent)" id="dbCount">0 MOVIES</b></span>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-ghost admin-only" style="width:auto; margin:0; padding:2px 8px;" onclick="openDataPortal()">EXPORT</button>
            <button class="btn btn-ghost" style="width:auto; margin:0; padding:2px 8px;" onclick="toggleAccess()">SWITCH</button>
        </div>
    </div>

    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
        <h1 class="brand-title">MISE</h1>
        <button class="btn admin-only" style="width:auto; padding: 5px 15px;" onclick="openAddModal()">+ ADD</button>
    </header>

    <input type="text" id="searchBox" placeholder="Search Title, Genre, Vibe, or Cast..." oninput="render()">

    <div class="scroll-box">
        <table>
            <thead>
                <tr>
                    <th rowspan="2" class="sticky-col" id="th-title" onclick="setSort('title')">Information & Cast</th>
                    <th rowspan="2" id="th-review">Review</th>
                    <th colspan="8" style="text-align: center; border-bottom: 1px solid #333; letter-spacing: 1px;">The Frame (Critique)</th>
                    <th colspan="6" style="text-align: center; border-bottom: 1px solid var(--exp-accent); color: var(--exp-accent); letter-spacing: 1px;">The Watch (Experience)</th>
                </tr>
                <tr>
                    <th id="th-overall" onclick="setSort('overall')">Overall</th>
                    <th id="th-Story" onclick="setSort('Story')">Story</th>
                    <th id="th-Character-Performance" onclick="setSort('Character / Performance')">Character / Performance</th>
                    <th id="th-Direction-Vision" onclick="setSort('Direction / Vision')">Direction / Vision</th>
                    <th id="th-Cinematography-Visuals" onclick="setSort('Cinematography / Visuals')">Cinematography / Visuals</th>
                    <th id="th-Editing-Pacing" onclick="setSort('Editing / Pacing')">Editing / Pacing</th>
                    <th id="th-Sound-Music" onclick="setSort('Sound / Music')">Sound / Music</th>
                    <th id="th-Thematic-Emotional-Cohesion" onclick="setSort('Thematic / Emotional Cohesion')">Thematic / Emotional Cohesion</th>
                    
                    <th id="th-exp-overall" onclick="setSort('exp-overall')">EXP OVR</th>
                    <th id="th-Emotion" onclick="setSort('Emotion')">Emotion</th>
                    <th id="th-Attention" onclick="setSort('Attention')">Attention</th>
                    <th id="th-Connection" onclick="setSort('Connection')">Connection</th>
                    <th id="th-Impact" onclick="setSort('Impact')">Impact</th>
                    <th id="th-Engagement" onclick="setSort('Engagement')">Engagement</th>
                </tr>
            </thead>
            <tbody id="mBody"></tbody>
        </table>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h3 id="modalHead">NEW MOVIE ENTRY</h3>
            <form id="addForm">
                <div id="wikiSection">
                    <input type="text" id="wikiIn" class="mini-input" placeholder="Wikipedia URL">
                    <button type="button" class="btn btn-ghost" onclick="fetchWiki()" id="vBtn">Auto-Extract Details</button>
                    <hr style="border:0; border-top:1px solid #222; margin: 12px 0;">
                </div>
                
                <input type="text" id="mTitle" class="mini-input" placeholder="Title" required>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="mYear" class="mini-input" placeholder="Year" style="width:30%">
                    <input type="text" id="mGenre" class="mini-input" placeholder="Genre" style="width:70%">
                </div>
                <input type="text" id="mUrl" class="mini-input" placeholder="YouTube Link">
                <input type="text" id="mOtt" class="mini-input" placeholder="Affiliate Link">
                <input type="text" id="mDir" class="mini-input" placeholder="Director">
                <input type="text" id="mLang" class="mini-input" placeholder="Language">
                <input type="text" id="mCast" class="mini-input" placeholder="Cast (Comma sep)">
                <input type="hidden" id="mPoster">
                
                <button type="button" class="btn" onclick="saveMovie()">Commit Changes</button>
                <button type="button" id="deleteBtn" class="btn btn-danger" style="display:none;" onclick="deleteEntry()">DELETE ENTRY</button>
                <button type="button" class="btn btn-ghost" onclick="hideModals()">Discard</button>
            </form>
        </div>
    </div>

    <div id="dataPortalModal" class="modal">
        <div class="modal-content">
            <h3>DATA PORTAL</h3>
            <p style="font-size:0.6rem; color:var(--text-dim)">Copy this code and paste it into the "let movies = [];" line in your HTML file to make reviews public.</p>
            <textarea id="dataOutput" class="mini-input" readonly style="height: 200px; font-family: monospace; font-size: 0.6rem;"></textarea>
            <button class="btn" onclick="copyData()">COPY TO CLIPBOARD</button>            <button class="btn btn-ghost" onclick="hideModals()">CLOSE</button>
        </div>
    </div>

    <div id="scoreModal" class="modal">
        <div class="modal-content">
            <h3 id="scoreTitle" style="color:var(--accent); margin:0;"></h3>
            <p id="scoreSub" style="font-size:0.6rem; color:var(--text-dim); margin-bottom:15px;"></p>
            
            <label style="font-size:0.6rem; color:var(--text-dim)">VIBE TAGS (MAX 3)</label>
            <div id="tagCloud" style="margin: 5px 0;"></div>
            <input type="text" id="customTag" class="mini-input" placeholder="+ Add Vibe" onkeydown="if(event.key==='Enter') addCustomTag()">

            <div id="sliders"></div>

            <div style="background:#000; padding:10px; border-radius:8px; margin-top:10px; text-align:center;">
                <span id="liveOvrEmoji" style="font-size:1.5rem;">üßç</span>
                <b id="liveOvrVal" style="font-size:1.5rem; color:var(--accent); margin-left:10px;">3.0</b>
            </div>

            <button class="btn" onclick="saveScores()">Update Ratings</button>
            <button class="btn btn-ghost" onclick="hideModals()">Close</button>
        </div>
    </div>

    <div id="expScoreModal" class="modal">
        <div class="modal-content" style="border-color: var(--exp-accent);">
            <h3 id="expScoreTitle" style="color:var(--exp-accent); margin:0;"></h3>
            <p id="expScoreSub" style="font-size:0.6rem; color:var(--text-dim); margin-bottom:15px;"></p>

            <div id="expSliders"></div>

            <div style="background:#000; padding:10px; border-radius:8px; margin-top:10px; text-align:center;">
                <span id="expLiveOvrEmoji" style="font-size:1.5rem;">üßç</span>
                <b id="expLiveOvrVal" style="font-size:1.5rem; color:var(--exp-accent); margin-left:10px;">3.0</b>
            </div>

            <button class="btn" style="background: var(--exp-accent);" onclick="saveExpScores()">Update Experience</button>
            <button class="btn btn-ghost" onclick="hideModals()">Close</button>
        </div>
    </div>

    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <h3 id="revTitle" style="color:var(--accent); margin:0;">MOVIE REVIEW</h3>
            <p id="revSub" style="font-size:0.6rem; color:var(--text-dim); margin-bottom:15px;"></p>
            <textarea id="revText" class="mini-input" placeholder="Write your thoughts here..."></textarea>
            <button class="btn" onclick="saveReview()">Save Review</button>
            <button class="btn btn-ghost" onclick="hideModals()">Discard</button>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <button class="nav-arrow nav-prev" onclick="navigateDetail(-1)">‚ùÆ</button>
        <div class="modal-content" style="max-width: 500px;" id="detailContentWrapper">
            <div id="detailContent"></div>
            <button class="btn btn-ghost" onclick="hideModals()">Close Detail</button>
        </div>
        <button class="nav-arrow nav-next" onclick="navigateDetail(1)">‚ùØ</button>
    </div>

    <div id="videoModal" class="modal" onclick="closeVideo()">
        <div class="modal-content" style="max-width: 800px; padding:0; background:#000; border:none;">
            <div id="playerWrapper"></div>
        </div>
    </div>

<script>
    const DB_KEY = 'mise_fortress_v33';
    const PRESET_TAGS = ["Neon", "Gritty", "Slow-Burn", "Cerebral", "Hectic", "Dreamy", "Nostalgic", "Bleak"];
    const emojis = { 1:'üíÄ', 1.5:'ü•Ä', 2:'üßç', 2.5:'üê¢', 3:'üçø', 3.5:'üß≤', 4:'üé≠', 4.5:'üí•', 5:'üî•' };
    const categories = ["Story", "Character / Performance", "Direction / Vision", "Cinematography / Visuals", "Editing / Pacing", "Sound / Music", "Thematic / Emotional Cohesion"];
    const expCategories = ["Emotion", "Attention", "Connection", "Impact", "Engagement"];

    const frameCritique = {
        "Story": { 1: {w: "Chaotic", d: "Incoherent or nonexistent."}, 1.5: {w: "Fragmented", d: "Minimally recognizable but ineffective."}, 2: {w: "Weak", d: "Weakly executed, inconsistent pacing."}, 2.5: {w: "Functional", d: "Functional but lacks originality."}, 3: {w: "Clear", d: "Clear and coherent narrative flow."}, 3.5: {w: "Engaging", d: "Defined arcs with minor pacing issues."}, 4: {w: "Compelling", d: "Original, well-paced, and satisfying."}, 4.5: {w: "Excellent", d: "Nearly flawless structure."}, 5: {w: "Outstanding", d: "Exemplary, resonant, and memorable."}},
        "Character / Performance": { 1: {w: "Wooden", d: "Unconvincing, flat characters."}, 1.5: {w: "Weak", d: "Delivery is awkward or inconsistent."}, 2: {w: "Uneven", d: "Performances are patchy."}, 2.5: {w: "Adequate", d: "Competent but unremarkable."}, 3: {w: "Solid", d: "Believable and clear presence."}, 3.5: {w: "Strong", d: "Generally excellent with minor flaws."}, 4: {w: "Excellent", d: "Convincing and emotionally engaging."}, 4.5: {w: "Superb", d: "Exceptional and fully credible."}, 5: {w: "Masterful", d: "Extraordinary and unforgettable."}},
        "Direction / Vision": { 1: {w: "Aimless", d: "Vision absent or tone inconsistent."}, 1.5: {w: "Unfocused", d: "Minimal intention visible."}, 2: {w: "Weak", d: "Recognizable but lacks flow."}, 2.5: {w: "Functional", d: "Consistent vision, lacks flair."}, 3: {w: "Clear", d: "Vision evident and smooth."}, 3.5: {w: "Engaging", d: "Skillful with minor style flaws."}, 4: {w: "Strong", d: "Consistent tone and high polish."}, 4.5: {w: "Excellent", d: "Nearly perfect cohesion."}, 5: {w: "Masterful", d: "Visionary and intellectually resonant."}},
        "Cinematography / Visuals": { 1: {w: "Flat", d: "Poor composition, distracting lighting."}, 1.5: {w: "Weak", d: "Minimal effort, unappealing."}, 2: {w: "Uneven", d: "Inconsistent quality, moments of skill."}, 2.5: {w: "Functional", d: "Competent but not memorable."}, 3: {w: "Clear", d: "Well-framed and coherent style."}, 3.5: {w: "Strong", d: "Visually appealing impact."}, 4: {w: "Excellent", d: "Strongly enhances the story."}, 4.5: {w: "Superb", d: "Visually outstanding polish."}, 5: {w: "Masterful", d: "Innovative and exemplary."}},
        "Editing / Pacing": { 1: {w: "Chaotic", d: "Scenes cut poorly, flow lost."}, 1.5: {w: "Uneven", d: "Jarring or inconsistent cuts."}, 2: {w: "Clunky", d: "Inconsistent pacing, awkward flow."}, 2.5: {w: "Functional", d: "Mostly coherent and polished."}, 3: {w: "Smooth", d: "Seamless and logical transitions."}, 3.5: {w: "Skilled", d: "Strong and effective rhythm."}, 4: {w: "Excellent", d: "Precise fluid transitions."}, 4.5: {w: "Superb", d: "Outstanding narrative rhythm."}, 5: {w: "Masterful", d: "Flawless, perfect pacing."}},
        "Sound / Music": { 1: {w: "Distracting", d: "Poor mixing harms comprehension."}, 1.5: {w: "Weak", d: "Largely ineffective or inconsistent."}, 2: {w: "Uneven", d: "Inconsistently executed moments."}, 2.5: {w: "Functional", d: "Mostly clear, serves purpose."}, 3: {w: "Clear", d: "Effective support of story."}, 3.5: {w: "Strong", d: "Atmospheric and well-executed."}, 4: {w: "Excellent", d: "Adds emotional/narrative depth."}, 4.5: {w: "Superb", d: "Fully integrated experience."}, 5: {w: "Masterful", d: "Elevates and immerses."}},
        "Thematic / Emotional Cohesion": { 1: {w: "Confused", d: "Muddled themes, no intent."}, 1.5: {w: "Weak", d: "Visible but ineffective intent."}, 2: {w: "Uneven", d: "Arcs partially clear but patchy."}, 2.5: {w: "Functional", d: "Understandable but not resonant."}, 3: {w: "Clear", d: "Consistent tone and resonance."}, 3.5: {w: "Strong", d: "Compelling and well-integrated."}, 4: {w: "Excellent", d: "Significant impact and meaning."}, 4.5: {w: "Superb", d: "Outstanding resonance."}, 5: {w: "Masterful", d: "Profound and deeply resonant."}}
    };

    const theWatchData = {
        "Emotion": { 1: {w: "Detached", d: "Zero emotional impact."}, 1.5: {w: "Dull", d: "Fails to evoke feeling."}, 2: {w: "Cold", d: "Minimal emotional connection."}, 2.5: {w: "Passive", d: "Intermittent moments of feeling."}, 3: {w: "Affecting", d: "Clearly felt presence of mood."}, 3.5: {w: "Stirring", d: "Moves the viewer significantly."}, 4: {w: "Powerful", d: "Deeply moving experience."}, 4.5: {w: "Overwhelming", d: "Highly visceral emotional response."}, 5: {w: "Transcendent", d: "Life-altering emotional resonance."}},
        "Attention": { 1: {w: "Boring", d: "Lost interest immediately."}, 1.5: {w: "Distracted", d: "Mind wandered frequently."}, 2: {w: "Tiring", d: "Felt like a chore to watch."}, 2.5: {w: "Steady", d: "Easy to follow but unremarkable."}, 3: {w: "Held", d: "Kept focus throughout."}, 3.5: {w: "Fixed", d: "Hard to look away."}, 4: {w: "Gripping", d: "Fully locked into the screen."}, 4.5: {w: "Compulsive", d: "Total absorption."}, 5: {w: "Rapt", d: "Complete and absolute immersion."}},
        "Connection": { 1: {w: "Alien", d: "Felt no kinship with themes/chars."}, 1.5: {w: "Remote", d: "Struggled to relate."}, 2: {w: "Vague", d: "Minor points of contact."}, 2.5: {w: "Shared", d: "Recognizable human elements."}, 3: {w: "Relatable", d: "Felt understood by the film."}, 3.5: {w: "Intimate", d: "Strong personal resonance."}, 4: {w: "Bonded", d: "Deeply synced with the message."}, 4.5: {w: "Unified", d: "Mirroring personal experiences."}, 5: {w: "Soulful", d: "Profound cosmic connection."}},
        "Impact": { 1: {w: "Forgettable", d: "Left no memory after finish."}, 1.5: {w: "Fleeting", d: "Faded within minutes."}, 2: {w: "Light", d: "A minor impression left."}, 2.5: {w: "Modest", d: "Some thoughts provoked."}, 3: {w: "Lasting", d: "Stuck in the head for a day."}, 3.5: {w: "Weighty", d: "Considerable mental footprint."}, 4: {w: "Resonant", d: "Influenced thought process."}, 4.5: {w: "Haunting", d: "Unable to stop thinking about it."}, 5: {w: "Permanent", d: "Altered your perspective forever."}},
        "Engagement": { 1: {w: "Static", d: "No desire to continue."}, 1.5: {w: "Slow", d: "Low energy throughout."}, 2: {w: "Average", d: "Middle-of-the-road pace."}, 2.5: {w: "Active", d: "Enjoyable energy levels."}, 3: {w: "Lively", d: "Satisfying momentum."}, 3.5: {w: "Dynamic", d: "High-octane interest."}, 4: {w: "Thorough", d: "Engaged in every single detail."}, 4.5: {w: "Electric", d: "Buzzing with excitement."}, 5: {w: "Peak", d: "Maximum possible investment."}}
    };

    /** IMPORTANT: This is where you paste your exported data for the public to see **/
    let movies = [{"id":1770655631623,"title":"Aavesham (2024 Film)","year":"2024","genre":"","url":"","ottUrl":"","director":"Jithu Madhavan","lang":"Malayalam","cast":["Fahadh Faasilhipzstermithun Jai Sankarroshan Shanavassajin Gopumidhutty"],"poster":"https://upload.wikimedia.org/wikipedia/en/d/d1/Aavesham.jpg","tags":["Hectic","Gritty","Chaos"],"ratings":[{"scores":{"Story":4,"Character / Performance":3.5,"Direction / Vision":4,"Cinematography / Visuals":4,"Editing / Pacing":4.5,"Sound / Music":4.5,"Thematic / Emotional Cohesion":4}}],"review":"asdfg","experience":{"Emotion":3.5,"Attention":3.5,"Connection":4,"Impact":3.5,"Engagement":4}},{"id":1770655754256,"title":"Premalu","year":"2024","genre":"","url":"","ottUrl":"https://youtu.be/rR_2ti4l3nM?si=dOGQHBFM76NUfTy_","director":"Girish A. D.","lang":"Malayalam","cast":["Naslenmamitha Baiju"],"poster":"https://upload.wikimedia.org/wikipedia/en/c/c5/Premalu_film_poster.jpg","tags":["Dreamy","Romantic"],"ratings":[{"scores":{"Story":3,"Character / Performance":3,"Direction / Vision":3,"Cinematography / Visuals":3,"Editing / Pacing":3,"Sound / Music":3,"Thematic / Emotional Cohesion":3}}],"experience":{"Emotion":3,"Attention":3,"Connection":3,"Impact":3,"Engagement":3}},{"id":1770656235384,"title":"Kumbalangi Nights","year":"2019","genre":"","url":"","ottUrl":"","director":"Madhu C. Narayanan","lang":"Malayalam","cast":["Shane Nigamsoubin Shahirfahadh Faasilsreenath Bhasimathew Thomas"],"poster":"https://upload.wikimedia.org/wikipedia/en/9/98/Kumbalangi_Nights_poster.jpg","tags":["Nostalgic","Cerebral","Slow-Burn"],"ratings":[{"scores":{"Story":3,"Character / Performance":3,"Direction / Vision":3,"Cinematography / Visuals":3,"Editing / Pacing":3,"Sound / Music":3,"Thematic / Emotional Cohesion":3}}],"experience":{"Emotion":3,"Attention":3,"Connection":3,"Impact":3,"Engagement":3}},{"id":1770656406008,"title":"Dhurandhar","year":"2025","genre":"Action Thriller","url":"","ottUrl":"","director":"Aditya Dhar","lang":"Hindi","cast":["Ranveer Singh Akshaye Khanna Sanjay Dutt Arjun Rampal R. Madhavan Danish Pandor Sara Arjun Rakesh Bedi"],"poster":"https://upload.wikimedia.org/wikipedia/en/c/ce/Dhurandhar_poster.jpg","tags":["Gritty","Hectic","Spy"],"ratings":[{"scores":{"Story":3,"Character / Performance":3,"Direction / Vision":3,"Cinematography / Visuals":3,"Editing / Pacing":3,"Sound / Music":3,"Thematic / Emotional Cohesion":3}}],"experience":{"Emotion":3,"Attention":3,"Connection":3,"Impact":3,"Engagement":3}},{"id":1770656591080,"title":"Draft:Aashaan","year":"","genre":"","url":"","ottUrl":"","director":"Johnpaul George","lang":"Malayalam","cast":["Indrans Joemon Jyothir Shobi Thilakan Madan Gowri Bibin Perumpally Abin Bino Kudassanad Kanakam"],"poster":"","tags":[],"ratings":[{"scores":{"Story":3,"Character / Performance":3,"Direction / Vision":3,"Cinematography / Visuals":3,"Editing / Pacing":3,"Sound / Music":3,"Thematic / Emotional Cohesion":3}}],"experience":{"Emotion":3,"Attention":3,"Connection":3,"Impact":3,"Engagement":3}},{"id":1770656934505,"title":"Varnapakittu","year":"1997","genre":"","url":"https://youtu.be/T6TaSMLL23s","ottUrl":"https://sainaplay.com/movie/varnapakittu/mlbkywsbsk6i","director":"I. V. Sasi","lang":"Malayalam","cast":["Mohanlalmeena"],"poster":"https://upload.wikimedia.org/wikipedia/en/e/e3/Varnapakittu.jpg","tags":["Romantic","Dreamy"],"ratings":[{"scores":{"Story":3,"Character / Performance":3,"Direction / Vision":3,"Cinematography / Visuals":3,"Editing / Pacing":3,"Sound / Music":3,"Thematic / Emotional Cohesion":3}}],"experience":{"Emotion":3,"Attention":3,"Connection":3,"Impact":3,"Engagement":3}},{"id":1770659407053,"title":"Mean Girls","year":"2004","genre":"Teen Comedy","url":"","ottUrl":"https://www.netflix.com/title/60034551","director":"Mark Waters","lang":"English","cast":["Lindsay Lohan Rachel Mcadams Tim Meadows Ana Gasteyer Amy Poehler Tina Fey"],"poster":"https://upload.wikimedia.org/wikipedia/en/a/ac/Mean_Girls_film_poster.png","tags":[],"ratings":[{"scores":{"Story":3,"Character / Performance":3,"Direction / Vision":3,"Cinematography / Visuals":3,"Editing / Pacing":3,"Sound / Music":3,"Thematic / Emotional Cohesion":3}}],"experience":{"Emotion":3,"Attention":3,"Connection":3,"Impact":3,"Engagement":3}},{"id":1770660367340,"title":"Marthanda Varma (Film)","year":"1933","genre":"","url":"","ottUrl":"","director":"P. V. Rao","lang":"Silent Film With Intertitles In English And Malayalam","cast":["Jaideva. V. P. Menondevakipadmini"],"poster":"https://upload.wikimedia.org/wikipedia/commons/0/01/MARTHANDA_VARMA_1933.jpeg","tags":[],"ratings":[{"scores":{"Story":3,"Character / Performance":3,"Direction / Vision":3,"Cinematography / Visuals":3,"Editing / Pacing":3,"Sound / Music":3,"Thematic / Emotional Cohesion":3}}],"experience":{"Emotion":3,"Attention":3,"Connection":3,"Impact":3,"Engagement":3}},{"id":1770743228916,"title":"Maniyarayile Ashokan","year":"2020","genre":"","url":"","ottUrl":"","director":"Shamzu Zayba","lang":"Malayalam","cast":["Jacob Gregoryanupama Parameswaran"],"poster":"https://upload.wikimedia.org/wikipedia/en/1/18/Maniyarayile_Asokan.jpg","tags":["Slow-Burn"],"ratings":[{"scores":{"Story":3.5,"Character / Performance":3.5,"Direction / Vision":3.5,"Cinematography / Visuals":3,"Editing / Pacing":3.5,"Sound / Music":3.5,"Thematic / Emotional Cohesion":4}}],"review":"Watchable movie","experience":{"Emotion":4,"Attention":5,"Connection":4,"Impact":3,"Engagement":3.5}},{"id":1770831141797,"title":"A Minecraft Movie","year":"2025","genre":"","url":"","ottUrl":"","director":"Jared Hess","lang":"English","cast":["Jason Momoa Jack Black Emma Myers Danielle Brooks Sebastian Hansen Jennifer Coolidge"],"poster":"https://upload.wikimedia.org/wikipedia/en/6/66/A_Minecraft_Movie_poster.jpg","tags":[],"ratings":[{"scores":{"Story":3,"Character / Performance":3,"Direction / Vision":3,"Cinematography / Visuals":3,"Editing / Pacing":3,"Sound / Music":3,"Thematic / Emotional Cohesion":3}}],"review":"","experience":{"Emotion":3,"Attention":3,"Connection":3,"Impact":3,"Engagement":3}}]; 

    let sortKey = 'overall', currentId = null, currentEditingId = null, activeTags = [], popTimer = null;
    let touchStartX = 0;

    window.onload = () => { 
        load();
        initSwipe();
    };

    function initSwipe() {
        const wrapper = document.getElementById('detailContentWrapper');
        wrapper.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
        wrapper.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].screenX;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) navigateDetail(diff > 0 ? 1 : -1);
        }, {passive: true});
    }

    function navigateDetail(dir) {
        if (currentId === null) return;
        const query = document.getElementById('searchBox').value.toLowerCase();
        const activeList = movies.filter(m => {
            const tagStr = (m.tags || []).join(' ');
            const castStr = (m.cast || []).join(' ');
            const searchPool = `${m.title} ${m.director} ${m.genre} ${castStr} ${tagStr} ${m.review || ''}`.toLowerCase();
            return !query || searchPool.includes(query);
        }).sort((a, b) => {
            if (sortKey === 'title') return a.title.localeCompare(b.title);
            if (sortKey === 'exp-overall') return calculateExpScore(b, 'overall') - calculateExpScore(a, 'overall');
            if (expCategories.includes(sortKey)) return calculateExpScore(b, sortKey) - calculateExpScore(a, sortKey);
            return calculateScore(b, sortKey) - calculateScore(a, sortKey);
        });

        const currentIdx = activeList.findIndex(m => m.id === currentId);
        let nextIdx = currentIdx + dir;
        if (nextIdx < 0) nextIdx = activeList.length - 1;
        if (nextIdx >= activeList.length) nextIdx = 0;
        
        if (activeList[nextIdx]) openDetail(activeList[nextIdx].id);
    }

    function load() { 
        // Logic: Combine hardcoded 'movies' with any local browser changes
        const localData = JSON.parse(localStorage.getItem(DB_KEY));
        if (localData && localData.length > 0) {
            movies = localData; 
        }
        document.getElementById('dbCount').innerText = `${movies.length} MOVIES`; 
        render(); 
    }

    function save() { localStorage.setItem(DB_KEY, JSON.stringify(movies)); document.getElementById('dbCount').innerText = `${movies.length} MOVIES`; }
    
    function openDataPortal() {
        document.getElementById('dataOutput').value = JSON.stringify(movies);
        showModal('dataPortalModal');
    }

    function copyData() {
        const el = document.getElementById('dataOutput');
        el.select();
        document.execCommand('copy');
        alert("Data copied! Now paste this into your HTML file's 'let movies = [];' line.");
    }

    function toTitleCase(s) { return s ? s.toLowerCase().replace(/\b\w/g, c => c.toUpperCase()) : ""; }

    function resetFormUI() {
        document.getElementById('addForm').reset();
        const vBtn = document.getElementById('vBtn');
        vBtn.innerText = "Auto-Extract Details";
        vBtn.style.color = "var(--text-dim)";
        document.getElementById('wikiIn').value = "";
        document.getElementById('deleteBtn').style.display = 'none';
    }

    async function fetchWiki() {
        const url = document.getElementById('wikiIn').value.trim();
        const vBtn = document.getElementById('vBtn');
        if(!url.includes('/wiki/')) return;
        vBtn.innerText = "SCRAPING...";
        try {
            const slug = url.split('/wiki/').pop();
            const sumRes = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${slug}`);
            const sumData = await sumRes.json();
            const htmlRes = await fetch(`https://en.wikipedia.org/api/rest_v1/page/html/${slug}`);
            const doc = new DOMParser().parseFromString(await htmlRes.text(), 'text/html');
            const infobox = doc.querySelector('.infobox');
            const getMeta = (label) => {
                const row = Array.from(infobox?.querySelectorAll('tr') || []).find(r => r.innerText.includes(label));
                if (!row) return "";
                const cell = row.querySelector('td');
                cell.querySelectorAll('style, script, .reference').forEach(e => e.remove());
                return cell.innerText.replace(/\s+/g, ' ').trim();
            };
            document.getElementById('mTitle').value = sumData.title || "";
            document.getElementById('mPoster').value = sumData.thumbnail?.source || "";
            document.getElementById('mYear').value = sumData.extract?.match(/\b(19|20)\d{2}\b/)?.[0] || "";
            document.getElementById('mGenre').value = toTitleCase(getMeta('Genre'));
            document.getElementById('mDir').value = toTitleCase(getMeta('Directed by'));
            document.getElementById('mLang').value = toTitleCase(getMeta('Language'));
            document.getElementById('mCast').value = getMeta('Starring').replace(/  /g, ', ');
            vBtn.innerText = "SUCCESS"; vBtn.style.color = "var(--success)";
        } catch(e) { vBtn.innerText = "ERROR"; vBtn.style.color = "var(--danger)"; }
    }

    function openAddModal() { currentEditingId = null; resetFormUI(); document.getElementById('modalHead').innerText = "NEW MOVIE ENTRY"; document.getElementById('wikiSection').style.display = 'block'; showModal('addModal'); }

    function editMovie(id) {
        currentEditingId = id; const m = movies.find(x => x.id === id);
        resetFormUI();
        document.getElementById('modalHead').innerText = "EDIT ENTRY";
        document.getElementById('wikiSection').style.display = 'none';
        document.getElementById('deleteBtn').style.display = 'block';
        document.getElementById('mTitle').value = m.title;
        document.getElementById('mYear').value = m.year;
        document.getElementById('mGenre').value = m.genre;
        document.getElementById('mUrl').value = m.url;
        document.getElementById('mOtt').value = m.ottUrl || '';
        document.getElementById('mDir').value = m.director;
        document.getElementById('mLang').value = m.lang;
        document.getElementById('mCast').value = (m.cast || []).join(', ');
        document.getElementById('mPoster').value = m.poster;
        showModal('addModal');
    }

    function openDetail(id) {
        currentId = id;
        const m = movies.find(x => x.id === id);
        if(!m) return;
        const ovr = calculateScore(m, 'overall');
        const expOvr = calculateExpScore(m, 'overall');
        
        let html = `
            <div class="detail-header">
                <img src="${m.poster}" class="detail-poster" onerror="this.src='https://via.placeholder.com/100x150?text=?'">
                <div>
                    <h2 style="color:var(--accent); margin:0;">${m.title}</h2>
                    <p style="margin:5px 0; font-size:0.8rem;">${m.year} | ${m.genre}</p>
                    <p style="margin:2px 0; font-size:0.7rem; color:var(--text-dim)">Directed by ${m.director || 'Unknown'}</p>
                    <div style="margin-top:10px; display: flex; align-items: center; gap: 10px;">
                        <div style="text-align: center;">
                            <span style="font-size:1.2rem; display:block;">${getIcon(ovr)}</span> 
                            <b style="color:var(--accent); font-size:1rem;">${ovr}</b>
                            <div style="font-size:0.5rem; color:var(--text-dim)">THE FRAME</div>
                        </div>
                        <span style="color:var(--border); font-size: 1.5rem;">|</span>
                        <div style="text-align: center;">
                            <span style="font-size:1.2rem; display:block;">${getIcon(expOvr)}</span> 
                            <b style="color:var(--exp-accent); font-size:1rem;">${expOvr}</b>
                            <div style="font-size:0.5rem; color:var(--text-dim)">THE WATCH</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap;">
                ${m.url ? `<button type="button" class="ott-link" style="background:var(--accent); cursor:pointer; border:none; color:black;" onclick="playVideo('${m.url}')">WATCH TRAILER</button>` : ''}
                ${m.ottUrl ? `<a href="${m.ottUrl}" target="_blank" class="ott-link">WATCH ON STREAMING</a>` : ''}
            </div>

            <p style="font-size:0.75rem; font-style:italic; color:var(--text-dim); border-left: 2px solid var(--accent); padding-left:10px; margin-bottom: 20px;">${m.review || 'No review written yet.'}</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="font-size: 0.6rem; color: var(--accent); margin-bottom: 8px; border-bottom: 1px solid #333;">THE FRAME</h4>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        ${categories.map(c => `
                            <div class="score-item" style="margin-bottom: 0;">
                                <span class="score-label">${c}</span>
                                <b>${getIcon(calculateScore(m, c))} ${calculateScore(m, c)}</b>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div>
                    <h4 style="font-size: 0.6rem; color: var(--exp-accent); margin-bottom: 8px; border-bottom: 1px solid #333;">THE WATCH</h4>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        ${expCategories.map(c => `
                            <div class="score-item exp" style="margin-bottom: 0;">
                                <span class="score-label">${c}</span>
                                <b>${getIcon(calculateExpScore(m, c))} ${calculateExpScore(m, c)}</b>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        document.getElementById('detailContent').innerHTML = html;
        showModal('detailModal');
    }
    function saveMovie() {
        const title = toTitleCase(document.getElementById('mTitle').value.trim());
        if(!title) return;
        const exists = movies.some(m => m.title.toLowerCase() === title.toLowerCase() && m.id !== currentEditingId);
        if (exists) { alert("This movie is already in your list!"); return; }
        const movieData = {
            title, year: document.getElementById('mYear').value,
            genre: toTitleCase(document.getElementById('mGenre').value),
            url: document.getElementById('mUrl').value.trim(),
            ottUrl: document.getElementById('mOtt').value.trim(),
            director: toTitleCase(document.getElementById('mDir').value),
            lang: toTitleCase(document.getElementById('mLang').value),
            cast: document.getElementById('mCast').value.split(',').map(c => toTitleCase(c.trim())).filter(c => c),
            poster: document.getElementById('mPoster').value,
        };
        if (currentEditingId) { const idx = movies.findIndex(m => m.id === currentEditingId); movies[idx] = { ...movies[idx], ...movieData }; }
        else { movies.push({ id: Date.now(), ...movieData, tags: [], ratings: [], review: '', experience: {} }); }
        save(); hideModals(); render();
    }

    function render() {
        const body = document.getElementById('mBody');
        const query = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('th').forEach(th => th.classList.remove('active-sort'));
        const activeTh = document.getElementById(`th-${sortKey.replace(/[\s\/]/g, '-')}`);
        if(activeTh) activeTh.classList.add('active-sort');
        const sorted = [...movies].sort((a, b) => {
            if (sortKey === 'title') return a.title.localeCompare(b.title);
            if (sortKey === 'exp-overall') return calculateExpScore(b, 'overall') - calculateExpScore(a, 'overall');
            if (expCategories.includes(sortKey)) return calculateExpScore(b, sortKey) - calculateExpScore(a, sortKey);
            return calculateScore(b, sortKey) - calculateScore(a, sortKey);
        });
        body.innerHTML = sorted.map(m => {
            const tagStr = (m.tags || []).join(' ');
            const castStr = (m.cast || []).join(' ');
            const searchPool = `${m.title} ${m.director} ${m.genre} ${castStr} ${tagStr} ${m.review || ''}`.toLowerCase();
            if (query && !searchPool.includes(query)) return '';
            
            const ovr = calculateScore(m, 'overall');
            const expOvr = calculateExpScore(m, 'overall');
            return `<tr>
                <td class="sticky-col">
                    <div style="display:flex; align-items:center;">
                        <img src="${m.poster}" class="poster" onclick="openDetail(${m.id})" onerror="this.src='https://via.placeholder.com/30x45?text=?'">
                        <div style="overflow:hidden; width:100%">
                            <span class="movie-name" onclick="playVideo('${m.url}')">
                                ${m.url ? '‚ñ∂ ' : ''}${m.title} 
                                <button class="admin-only edit-btn" onclick="event.stopPropagation(); editMovie(${m.id})">EDIT</button>
                            </span>
                            <div class="meta-row"><span style="color:var(--accent)">${m.genre || 'N/A'}</span> | ${m.year}</div>
                            <div class="meta-row" style="color: #999;">Dir: <span style="cursor:pointer;" onclick="filterByDirector('${m.director}')">${m.director || 'Unknown'}</span></div>
                            <div class="cast-row">Cast: ${(m.cast || []).slice(0, 3).join(', ')}</div>
                            ${m.ottUrl ? `<a href="${m.ottUrl}" target="_blank" class="ott-link">WATCH ON STREAMING</a>` : ''}
                            <div style="margin-top:2px;">${(m.tags || []).map(t => `<span class="tag-pill list-tag" onclick="filterByVibe('${t}')">${t}</span>`).join('')}</div>
                        </div>
                    </div>
                </td>
                <td onclick="openReviewModal(${m.id})" style="cursor:pointer; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:var(--text-dim); font-style:italic;">
                    ${m.review || '(Add Review)'}
                </td>
                <td onclick="openScoring(${m.id})"><div><span>${getIcon(ovr)}</span><b style="color:var(--accent)">${ovr}</b></div></td>
                ${categories.map(c => {
                    const score = calculateScore(m,c);
                    return `<td onclick="openScoring(${m.id})"><div><span>${getIcon(score)}</span><span style="color:var(--text-dim)">${score}</span><span class="score-keyword">${frameCritique[c][score]?.w || ""}</span></div></td>`
                }).join('')}
                <td onclick="openExpScoring(${m.id})"><div><span>${getIcon(expOvr)}</span><b style="color:var(--exp-accent)">${expOvr}</b></div></td>
                ${expCategories.map(c => {
                    const score = calculateExpScore(m,c);
                    return `<td onclick="openExpScoring(${m.id})"><div><span>${getIcon(score)}</span><span style="color:var(--text-dim)">${score}</span><span class="score-keyword" style="color:var(--exp-accent)">${theWatchData[c][score]?.w || ""}</span></div></td>`
                }).join('')}
            </tr>`;
        }).join('');
    }

    function openReviewModal(id) {
        if(document.body.className === 'is-viewer') return;
        currentId = id; const m = movies.find(x => x.id === id);
        document.getElementById('revTitle').innerText = m.title;
        document.getElementById('revText').value = m.review || '';
        showModal('reviewModal');
    }

    function saveReview() {
        const m = movies.find(x => x.id === currentId);
        m.review = document.getElementById('revText').value.trim();
        save(); hideModals(); render();
    }

    function filterByDirector(name) { if (!name) return; document.getElementById('searchBox').value = name; render(); }
    function filterByVibe(tag) { if (!tag) return; document.getElementById('searchBox').value = tag; render(); }

    function openScoring(id) {
        if(document.body.className === 'is-viewer') return;
        currentId = id; const m = movies.find(x => x.id === id); activeTags = [...(m.tags || [])];
        document.getElementById('scoreTitle').innerText = m.title;
        document.getElementById('scoreSub').innerText = `${m.year} ‚Ä¢ ${m.genre}`;
        renderTagCloud();
        const r = (m.ratings && m.ratings[0]) ? m.ratings[0] : { scores: {} };
        const container = document.getElementById('sliders');
        container.innerHTML = categories.map(cat => {
            const val = r.scores[cat] || 3;
            return `<div class="slider-row"><div style="display:flex;justify-content:space-between;font-size:0.6rem;color:var(--text-dim);margin-bottom:3px;"><span>${cat}</span><span><span id="emo-${cat.replace(/[\s\/]/g, '-')}">${getIcon(val)}</span> <b id="val-${cat.replace(/[\s\/]/g, '-')}">${val}</b> <i id="word-${cat.replace(/[\s\/]/g, '-')}" style="color: #a1a1aa"></i></span></div>
            <input type="range" min="1" max="5" step="0.5" value="${val}" id="sl-${cat.replace(/[\s\/]/g, '-')}" oninput="updateSliderUI('${cat}', true)"></div>`;
        }).join('');
        categories.forEach(c => updateSliderUI(c, false));
        showModal('scoreModal');
    }

    function openExpScoring(id) {
        if(document.body.className === 'is-viewer') return;
        currentId = id; const m = movies.find(x => x.id === id);
        document.getElementById('expScoreTitle').innerText = m.title;
        document.getElementById('expScoreSub').innerText = `${m.year} ‚Ä¢ ${m.genre} (The Watch)`;
        const exp = m.experience || {};
        const container = document.getElementById('expSliders');
        container.innerHTML = expCategories.map(cat => {
            const val = exp[cat] || 3;
            return `<div class="slider-row"><div style="display:flex;justify-content:space-between;font-size:0.6rem;color:var(--text-dim);margin-bottom:3px;"><span>${cat}</span><span><span id="exp-emo-${cat.replace(/[\s\/]/g, '-')}">${getIcon(val)}</span> <b id="exp-val-${cat.replace(/[\s\/]/g, '-')}">${val}</b> <i id="exp-word-${cat.replace(/[\s\/]/g, '-')}" style="color:var(--exp-accent)"></i></span></div>
            <input type="range" min="1" max="5" step="0.5" value="${val}" id="exp-sl-${cat.replace(/[\s\/]/g, '-')}" oninput="updateExpSliderUI('${cat}', true)"></div>`;
        }).join('');
        expCategories.forEach(c => updateExpSliderUI(c, false));
        showModal('expScoreModal');
    }

    function updateExpSliderUI(cat, showPopup) {
        const id = cat.replace(/[\s\/]/g, '-');
        const s = document.getElementById(`exp-sl-${id}`);
        const v = parseFloat(s.value);
        const data = theWatchData[cat][v] || {w:"", d:""};
        document.getElementById(`exp-val-${id}`).innerText = v;
        document.getElementById(`exp-emo-${id}`).innerText = getIcon(v);
        document.getElementById(`exp-word-${id}`).innerText = `(${data.w})`;
        const p = (v-1)/4;
        s.style.background = `linear-gradient(90deg, var(--exp-accent) 0%, var(--exp-accent) ${p*100}%, #333 ${p*100}%)`;
        let total = 0;
        expCategories.forEach(c => { total += parseFloat(document.getElementById(`exp-sl-${c.replace(/[\s\/]/g, '-')}`).value); });
        const avg = (total / expCategories.length).toFixed(1);
        document.getElementById('expLiveOvrVal').innerText = avg;
        document.getElementById('expLiveOvrEmoji').innerText = getIcon(avg);
        if(showPopup) triggerPopup(data.d);
    }

    function saveExpScores() {
        const m = movies.find(x => x.id === currentId);
        if(!m.experience) m.experience = {};
        expCategories.forEach(c => m.experience[c] = parseFloat(document.getElementById(`exp-sl-${c.replace(/[\s\/]/g, '-')}`).value));
        save(); hideModals(); render();
    }

    function updateSliderUI(cat, showPopup) {
        const id = cat.replace(/[\s\/]/g, '-');
        const s = document.getElementById(`sl-${id}`);
        const v = parseFloat(s.value);
        const data = frameCritique[cat][v] || {w:"", d:""};
        document.getElementById(`val-${id}`).innerText = v;
        document.getElementById(`emo-${id}`).innerText = getIcon(v);
        document.getElementById(`word-${id}`).innerText = `(${data.w})`;
        const p = (v-1)/4;
        const color = `rgb(${Math.floor(255*(1-p))},${Math.floor(255*p)},0)`;
        s.style.background = `linear-gradient(90deg, ${color} 0%, ${color} ${p*100}%, #333 ${p*100}%)`;
        let total = 0;
        categories.forEach(c => { total += parseFloat(document.getElementById(`sl-${c.replace(/[\s\/]/g, '-')}`).value); });
        const avg = (total / categories.length).toFixed(1);
        document.getElementById('liveOvrVal').innerText = avg;
        document.getElementById('liveOvrEmoji').innerText = getIcon(avg);
        if(showPopup) triggerPopup(data.d);
    }

    function triggerPopup(text) {
        const pop = document.getElementById('descPopup');
        pop.innerText = text; pop.style.opacity = "1";
        if(popTimer) clearTimeout(popTimer);
        popTimer = setTimeout(() => { pop.style.opacity = "0"; }, 2000);
    }

    function renderTagCloud() {
        const cloud = document.getElementById('tagCloud');
        const allPossible = Array.from(new Set([...PRESET_TAGS, ...activeTags]));
        cloud.innerHTML = allPossible.map(t => `<span class="tag-pill ${activeTags.includes(t) ? 'active' : ''}" style="cursor:pointer" onclick="toggleTag('${t}')">${t}</span>`).join('');
    }

    function toggleTag(t) { if (activeTags.includes(t)) activeTags = activeTags.filter(tag => tag !== t); else if (activeTags.length < 3) activeTags.push(t); renderTagCloud(); }
    function addCustomTag() { const input = document.getElementById('customTag'); const val = toTitleCase(input.value.trim()); if (val && !activeTags.includes(val) && activeTags.length < 3) { activeTags.push(val); input.value = ''; renderTagCloud(); } }

    function saveScores() { const m = movies.find(x => x.id === currentId); m.tags = activeTags; const scores = {}; categories.forEach(c => scores[c] = parseFloat(document.getElementById(`sl-${c.replace(/[\s\/]/g, '-')}`).value)); m.ratings = [{ scores }]; save(); hideModals(); render(); }
    
    function calculateScore(m, cat) { 
        if (!m.ratings?.length) return 0; 
        const r = m.ratings[0]; 
        if (cat === 'overall') { 
            let s = 0; 
            categories.forEach(c => s += (r.scores[c] || 0)); 
            return parseFloat((s / categories.length).toFixed(1)); 
        } 
        return r.scores[cat] || 0; 
    }

    function calculateExpScore(m, cat) {
        if (!m.experience) return 0;
        if (cat === 'overall') {
            let s = 0;
            expCategories.forEach(c => s += (m.experience[c] || 0));
            return parseFloat((s / expCategories.length).toFixed(1));
        }
        return m.experience[cat] || 0;
    }

    function getIcon(v) { const r = Math.round(v * 2) / 2; return emojis[r] || 'üçø'; }
    function setSort(key) { sortKey = key; render(); }
    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function hideModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function toggleAccess() { const p = prompt("?"); document.body.className = (p === "1234") ? "is-admin" : "is-viewer"; }
    function playVideo(url) {
        if (!url) return;
        const id = url?.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/)?.[1];
        if (id) {
            // Updated iframe with specific parameters to help bypass some restrictions
            // and added a fallback link in case the owner has disabled embedding (Error 153)
            document.getElementById('playerWrapper').innerHTML = `
                <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; background:#000;">
                    <iframe src="https://www.youtube.com/embed/${id}?autoplay=1&rel=0&origin=${window.location.origin}" 
                            style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" 
                            allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    <div style="position:absolute; bottom:10px; width:100%; text-align:center;">
                        <a href="https://www.youtube.com/watch?v=${id}" target="_blank" 
                           style="color:var(--accent); font-size:0.7rem; text-decoration:none; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:4px;">
                           Video not playing? Watch directly on YouTube
                        </a>
                    </div>
                </div>`;
            showModal('videoModal');
        } else {
            window.open(url, '_blank');
        }
    }
    function closeVideo() { document.getElementById('playerWrapper').innerHTML = ''; hideModals(); }

</script>
</body>

</html>

